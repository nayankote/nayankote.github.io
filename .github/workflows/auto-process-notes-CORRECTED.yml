name: Auto-Process Notes

# Triggers when files are added to notes/inbox/
on:
  push:
    paths:
      - 'notes/inbox/**'
  workflow_dispatch:
  repository_dispatch:
    types: [new-note]

jobs:
  process-notes:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies (only needed for LLM mode)
        run: |
          pip install anthropic
      
      - name: Process notes
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          cd notes
          python notes_parser.py inbox/ -o notes.json --llm
      
      - name: Archive processed notes
        run: |
          mkdir -p notes/archive/$(date +%Y-%m)
          mv notes/inbox/*.{txt,md} notes/archive/$(date +%Y-%m)/ 2>/dev/null || true
      
      - name: Commit and push if changed
        run: |
          git config user.name "Notes Bot"
          git config user.email "actions@github.com"
          
          git add notes/notes.json notes/archive/
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Auto-update notes [skip ci]"
            git push
          fi

# NOTE: If you want keyword-only tagging (no LLM, free):
# Change line 33 to: python notes_parser.py inbox/ -o notes.json
# Remove the --llm flag and skip setting up ANTHROPIC_API_KEY secret
