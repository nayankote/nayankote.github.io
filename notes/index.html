<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <title>Notes - Nayan Kote</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="stylesheet" type="text/css" href="/assets/css/style.css" />

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            overflow: hidden;
        }

        #graph-container {
            width: 100%;
            height: calc(100vh - 130px);
            position: relative;
        }

        svg {
            width: 100%;
            height: 100%;
        }

        .node circle {
            fill: #64748b;
            cursor: pointer;
            transition: fill 0.2s ease;
        }

        .node:hover circle {
            fill: var(--color-accent, #FF1A75);
        }

        .node text {
            font-size: 10px;
            fill: var(--color-text, #333);
            text-anchor: middle;
            pointer-events: none;
            opacity: 0;
        }

        .node:hover text {
            opacity: 1;
        }

        .link {
            stroke: #e2e8f0;
            stroke-width: 1;
            transition: stroke 0.2s ease, stroke-width 0.2s ease;
        }

        .link.highlighted {
            stroke: var(--color-accent, #FF1A75);
            stroke-width: 2;
        }

        .message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: var(--color-text, #333);
            font-family: 'Libre Baskerville', serif;
        }

        .message h3 {
            margin-bottom: 12px;
            color: var(--color-accent, #FF1A75);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: var(--color-bg, #fff);
            margin: 5% auto;
            padding: 24px;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .modal-title {
            font-size: 1em;
            font-weight: 600;
            color: var(--color-text, #333);
            font-family: 'Libre Baskerville', serif;
            line-height: 1.6;
            flex: 1;
            padding-right: 16px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .close {
            font-size: 24px;
            cursor: pointer;
            color: #94a3b8;
            line-height: 1;
        }

        .close:hover {
            color: var(--color-accent, #FF1A75);
        }

        .modal-metadata {
            display: flex;
            gap: 16px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .modal-date {
            font-size: 0.85em;
            color: #64748b;
        }

        .modal-cluster {
            font-size: 0.85em;
            color: var(--color-accent, #FF1A75);
            background: rgba(255, 26, 117, 0.1);
            padding: 2px 8px;
            border-radius: 4px;
        }

        .modal-body {
            font-size: 1em;
            color: var(--color-text, #333);
            font-family: 'Libre Baskerville', serif;
            line-height: 1.7;
            margin-top: 16px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .modal-subject {
            font-size: 0.85em;
            color: #64748b;
            font-style: italic;
            margin-top: 12px;
        }

        .empty-state {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: var(--color-text, #333);
            font-family: 'Libre Baskerville', serif;
            max-width: 400px;
            padding: 24px;
        }

        .empty-state h3 {
            color: var(--color-accent, #FF1A75);
            margin-bottom: 16px;
        }

        .empty-state p {
            line-height: 1.6;
            color: #64748b;
        }

        .notes-intro {
            max-width: 650px;
            margin: 0 auto;
            padding: 24px 32px 0 32px;
            font-family: 'Libre Baskerville', serif;
            font-size: 0.95em;
            color: #64748b;
            line-height: 1.6;
            text-align: center;
        }

        .notes-intro strong {
            color: var(--color-text, #333);
        }

        @media (max-width: 600px) {
            .notes-intro {
                padding: 16px 20px 0 20px;
            }
        }

        #reset-view-btn {
            background: none;
            border: 1px solid var(--color-accent, #FF1A75);
            border-radius: 4px;
            padding: 6px 10px;
            cursor: pointer;
            color: var(--color-accent, #FF1A75);
            margin-right: 12px;
        }

        #reset-view-btn:hover {
            background: var(--color-accent, #FF1A75);
            color: white;
        }

        /* Dark mode adjustments */
        .theme-dark .node circle {
            fill: #94a3b8;
        }

        .theme-dark .link {
            stroke: #334155;
        }

        .theme-dark .modal-content {
            background-color: #1e293b;
        }
    </style>

    <script>
        function setTheme(theme) {
            document.documentElement.classList.remove('theme-dark', 'theme-light');
            document.documentElement.classList.add(theme);
            localStorage.setItem('attila_theme', theme);
        }

        function getPreferredTheme() {
            const stored = localStorage.getItem('attila_theme');
            if (stored === 'dark' || stored === 'theme-dark') return 'theme-dark';
            if (stored === 'light' || stored === 'theme-light') return 'theme-light';
            return 'theme-light';
        }

        document.addEventListener('DOMContentLoaded', function () {
            setTheme(getPreferredTheme());
        });
    </script>
</head>

<body>
    <div class="nav-header">
        <nav class="nav-wrapper" aria-label="Main">
            <ul>
                <li class="nav-home"><a href="/"><span>Home</span></a></li>
                <li class="nav-blogs"><a href="/blogs/"><span>Blogs</span></a></li>
                <li class="nav-notes active"><a href="/notes/"><span>Notes</span></a></li>
            </ul>
            <button id="reset-view-btn" onclick="resetZoom()" aria-label="Reset view">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path>
                    <path d="M21 3v5h-5"></path>
                    <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path>
                    <path d="M3 21v-5h5"></path>
                </svg>
            </button>
            <a id="theme-toggle" href="#" aria-label="Toggle theme" onclick="event.preventDefault(); const current = document.documentElement.classList.contains('theme-dark') ? 'theme-dark' : 'theme-light'; setTheme(current === 'theme-dark' ? 'theme-light' : 'theme-dark');">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="5"></circle>
                    <line x1="12" y1="1" x2="12" y2="3"></line>
                    <line x1="12" y1="21" x2="12" y2="23"></line>
                    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                    <line x1="1" y1="12" x2="3" y2="12"></line>
                    <line x1="21" y1="12" x2="23" y2="12"></line>
                    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                </svg>
            </a>
        </nav>
    </div>

    <p class="notes-intro">
        <strong>Fleeting thoughts</strong> captured throughout my day.
        Click to read. Beta version.
    </p>

    <div id="graph-container">
        <div id="message"></div>
        <svg id="graph"></svg>
    </div>

    <div id="noteModal" class="modal" onclick="if(event.target===this) closeModal()">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle"></div>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-metadata">
                <div class="modal-date" id="modalDate"></div>
                <div class="modal-cluster" id="modalCluster"></div>
            </div>
            <div class="modal-body" id="modalBody"></div>
            <div class="modal-subject" id="modalSubject"></div>
        </div>
    </div>

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script>
        const NODE_RADIUS = 12;
        let notes = [], links = [], clusters = [], simulation = null;

        function showMessage(html) {
            document.getElementById('message').innerHTML = `<div class="message">${html}</div>`;
        }

        function showEmptyState() {
            document.getElementById('message').innerHTML = `
                <div class="empty-state">
                    <h3>No notes yet</h3>
                    <p>Start capturing your thoughts by emailing them to your notes inbox. They'll appear here as an interconnected web of ideas.</p>
                </div>
            `;
        }

        async function loadNotes() {
            showMessage('<h3>Loading notes...</h3>');

            try {
                const response = await fetch('notes_processed.json');

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                notes = data.notes || [];
                clusters = data.clusters || [];

                if (notes.length === 0) {
                    showEmptyState();
                    return;
                }

                // Build links from connections
                links = buildLinks(notes);
                document.getElementById('message').innerHTML = '';
                initializeGraph();

            } catch (error) {
                console.error('Error:', error);
                showMessage(`
                    <h3>Could not load notes</h3>
                    <p>Error: ${error.message}</p>
                `);
            }
        }

        function buildLinks(notes) {
            const linkSet = new Set();
            const links = [];

            for (const note of notes) {
                for (const conn of note.connections || []) {
                    // Create a unique key for this pair (order-independent)
                    const key = [note.id, conn.target_id].sort().join('-');

                    if (!linkSet.has(key)) {
                        linkSet.add(key);
                        links.push({
                            source: note.id,
                            target: conn.target_id,
                            similarity: conn.similarity
                        });
                    }
                }
            }

            return links;
        }

        function getClusterLabel(clusterId) {
            const cluster = clusters.find(c => c.id === clusterId);
            if (!cluster) return 'uncategorized';
            return cluster.custom_label || cluster.auto_label || 'uncategorized';
        }

        function formatDate(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        function initializeGraph() {
            const container = document.getElementById('graph-container');
            const width = container.clientWidth;
            const height = container.clientHeight;

            const svg = d3.select("#graph")
                .attr("viewBox", [0, 0, width, height]);

            svg.selectAll("*").remove();

            const g = svg.append("g");

            const zoom = d3.zoom()
                .scaleExtent([0.1, 4])
                .on("zoom", (event) => g.attr("transform", event.transform));

            svg.call(zoom);

            simulation = d3.forceSimulation(notes)
                .force("link", d3.forceLink(links)
                    .id(d => d.id)
                    .distance(80)
                    .strength(d => d.similarity * 0.5))
                .force("charge", d3.forceManyBody().strength(-200))
                .force("center", d3.forceCenter(width / 2, height / 2))
                .force("collision", d3.forceCollide().radius(NODE_RADIUS + 10));

            const link = g.append("g")
                .selectAll("line")
                .data(links)
                .join("line")
                .attr("class", "link")
                .style("opacity", d => 0.3 + d.similarity * 0.5);

            const node = g.append("g")
                .selectAll("g")
                .data(notes)
                .join("g")
                .attr("class", "node")
                .call(d3.drag()
                    .on("start", (e, d) => {
                        if (!e.active) simulation.alphaTarget(0.3).restart();
                        d.fx = d.x;
                        d.fy = d.y;
                    })
                    .on("drag", (e, d) => {
                        d.fx = e.x;
                        d.fy = e.y;
                    })
                    .on("end", (e, d) => {
                        if (!e.active) simulation.alphaTarget(0);
                        d.fx = null;
                        d.fy = null;
                    }))
                .on("click", (e, d) => openModal(d))
                .on("mouseenter", (e, d) => {
                    link.classed("highlighted", l =>
                        l.source.id === d.id || l.target.id === d.id
                    );
                })
                .on("mouseleave", () => link.classed("highlighted", false));

            node.append("circle")
                .attr("r", NODE_RADIUS);

            // Show truncated text on hover
            node.append("text")
                .attr("dy", NODE_RADIUS + 14)
                .text(d => d.text.length > 30 ? d.text.substring(0, 30) + '...' : d.text);

            simulation.on("tick", () => {
                link
                    .attr("x1", d => d.source.x)
                    .attr("y1", d => d.source.y)
                    .attr("x2", d => d.target.x)
                    .attr("y2", d => d.target.y);

                node.attr("transform", d => `translate(${d.x},${d.y})`);
            });

            window.svg = svg;
            window.zoom = zoom;
        }

        function openModal(note) {
            // Header: subject (bold, body font size)
            const titleEl = document.getElementById('modalTitle');
            if (note.subject) {
                titleEl.textContent = note.subject;
                titleEl.style.display = 'block';
            } else {
                titleEl.style.display = 'none';
            }

            document.getElementById('modalDate').textContent = formatDate(note.timestamp);
            document.getElementById('modalCluster').textContent = getClusterLabel(note.cluster_id);

            // Body: full note text
            document.getElementById('modalBody').textContent = note.text;

            // Category: small italic (cluster label already shown above, hide old subject field)
            document.getElementById('modalSubject').style.display = 'none';

            document.getElementById('noteModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('noteModal').style.display = 'none';
        }

        function resetZoom() {
            if (window.svg && window.zoom) {
                window.svg.transition().duration(750).call(window.zoom.transform, d3.zoomIdentity);
            }
        }

        // Close modal on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeModal();
        });

        loadNotes();
    </script>
</body>
</html>

